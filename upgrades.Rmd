---
title: "Upgrading Packages"
description: |
  How to Safely Upgrade Packages [In Progress]
---

Upgrading packages can be a risky affair. Most R users have been in a situation
where upgrading a package for a project accidentally breaks the code in another
project. Another common challenge is upgrading a package only to realize the
upgrade had unintended consequences, breaking other parts of your code. Luckily, the [strategies for reproducible environments](./reproduce.html) can make package upgrafes save. 

Specifically, there are two ways reproducible environments support package upgrades:

1. They encourage project isolation.
2. They provide a safety net in case you need to roll back a change.

This page describes the [Snaphot and Restore](./snapshot.html) strategy with an emphasis on package upgrades. Keep in mind that the other strategies promote safe package upgrades as well. We also present [troubleshooting tips](./upgrades.html#what-if-an-upgrade-breaks-code) for cases where upgrading a packgae breaks code.

## Snaphot and Restore for Upgrades

The first concern for safe upgrades is project isolation. By isolating projects, you can ensure that upgrading the packages for one project won't break code in other projects. This type of isolation is accomplished by
creating per-project libraries. The [`renv`
package](https://github.com/rstudio/renv) makes this easy. Inside of your R project, simply use:

```{r eval=FALSE, echo=TRUE}
# inside the project directory
renv::init()

# check to see the isolated project library
.libPaths()
```


The next concern for safely upgrading packages is creating a safety net. If the package upgrade goes poorly, you'll be
able to revert the changes and return to a working state. Again,
the `renv` package makes this process easy.

```{r eval=FALSE, echo=TRUE}
# record the current dependencies in a file called renv.lock
renv::snapshot()
# commit the lockfile alongside your code in version control
```


With an isolated project and a safety net in place, you can now proceed to
upgrade or add new packages, while remaining certain the current functional
environment is still reproducible. The [`pak`
package](https://github.com/r-lib/pak) can be used to install and upgrade
packages in an interactive environment:

```{r eval=FALSE, echo=TRUE}
# upgrade packages quickly and safely
pak::pkg_install("ggplot2")

# the interactive prompt shows you exactly what will change
# helping avoid unintentional or surprising changes
```


If the process of upgrading packages goes poorly, you can roll back the change using the safety net created earlier:

```{r eval=FALSE, echo=TRUE}
# use this function to view the history of your lockfile
renv::history()

# if an upgrade goes astray, revert the lockfile
renv::revert(commit = "abc123")

# and restore the previous environment
renv::restore()
```


The safety net provided by the `renv` package relies on access to older versions
of R packages. For public packages, CRAN provides these older versions in the
[CRAN archive](https://cran.rstudio.com/src/contrib/Archive). Organizations can
use tools like [RStudio Package
Manager](https://rstudio.com/products/package-manager) to make multiple versions
of private packages available

## What if an upgrade breaks code?

If your code fails to run after an upgrade, and you have time to investigate and fix instead of rolling back your change, the first place to look is package's News file. For example, this is the [ggplot2 News file](https://github.com/tidyverse/ggplot2/blob/master/NEWS). This file will normally explain what functions have changed, and detail what steps a user will need to take in order to fix their code. Focus on the changes listed between the version you were using and latest version - both pieces of information are displayed in the `pak` install prompt.

Sometimes package upgrades will leave your project library in an [inconsistent state](./shared.html#the-big-risk). A common indicator that this has occured is if you see errors when executing the `library` statements in your code. One fix is to upgrade all of the packages used in your project. It is best to restart the R session prior to performing these upgrades, as loaded packages can often prevent successful upgrades. The [Validated](./validated.html) and [Shared Baseline](./shared.html) strategies address this problem by requiring upgrades to the entire repository.
